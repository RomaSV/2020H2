# Module sevent-common

## Протокол sevent

Протокол использует описанный общий формат сообщений и клиент серверного 
взаимодействия.

Протокол описывает систему создания, прослушивания и оповещения о событиях, 
которые создаются клиентами данной системы и рассылаются сервером.

По умолчанию сервер выбирает TCP порт 5987 для прослушивания входящих 
подключений.

Каждый клиент формирует сессию, с которой ассоциируются фильтры для 
зарегистрированных типов событий в системе и самих событий.

Каждый тип события имеет имя, представленное в строке символов.

Каждое событие имеет набор типов события (или не имеет), описание события, 
период оповещения, количество повторов события, а также уникальный 
идентификатор события. Кроме этого система хранит время последнего 
обновления данных события. Обновление происходит при создании события и при 
оповещении.

После оповещения, участвующее событие отнимает 1 от счётчика повторов 
события и обновляет временную метку о последнем оповещении. При достижении 0
у значения счётчика повторов событие полностью удаляется из системы.

Если установленный счётчик повторов равен -1, то повторение оповещение о 
событии будут генерироваться в установленном порядке пока событие не будет 
удалено одним из клиентов по запросу. Иначе говоря значение -1 в количестве 
повторов символизирует бесконечное количество повторов. Другие отрицательные 
значения количества повторов запрещены. При регистрации события с количеством 
повторов 0 событие сразу же удаляется.

После регистрации события в системе одним из клиентов этому же клиенту 
приходит сообщение с идентификатором события и временем создания события.

Генерация идентификаторов событий делается последовательно через атомарный 
счётчик, который увеличивает своё значение на 1 после успешной регистрации 
следующего события. Последнее значение счетчика идентификаторов должно быть 
сохранено вместе с состоянием сервера. Должна обеспечиваться гарантия того, 
что идентификатор события уникален для каждого события и не может быть 2 и 
более событий в системе с одинаковым идентификатором. Текущее значение счётчика 
идентификаторов сохраняется в качестве идентификатора регистрируемого 
события при этом счётчик атомарно увеличивает своё значение на 1.

Регистрация события происходит передачей сообщения RegisterEvent по потоку от 
клиента к серверу. В ответ на сообщение RegisterEvent сервер посылает 
сообщение EventRegistration либо Error в случае ошибки.

После создания сессии клиент может настроить сессию. Для этого ему следует 
передать имена типов событий и(или) кодов событий, о которых он желает быть 
оповещённым. Клиент может обновить фильтр убрав и(или) добавив типы событий или 
идентификаторы событий в любое время работы существующей сессии.
Во время работы данной сессии ему будут переданы оповещения о событиях, на 
которые он подписан исходя из составленного фильтра.

После удаления события, идентификатор которого входит в фильтр, этот 
идентификатор удаляется из фильтра в сессии клиента.

Клиент может подписаться на тип события, которого ещё не существует в 
системе. Таким образом, когда тип события появится вместе с одним из событий,
то он будет получать оповещения об этом событии.

Клиент не может подписаться на событие, которого не существует в системе.

Любой клиент может запросить список всех зарегистрированных событий и(или) 
список событий определённых типов.

Любой клиент может добавить новое событие в систему.

Любой клиент может удалить любое событие из системы.

При получении оповещения клиент также получает все имеющиеся данные о 
событии, включая время последнего обновления (которое было установлено до 
этого оповещения). Это необходимо, так как событие должно удалиться из 
системы при достижении нуля в счётчике повторов.

Клиенту не следует делать несколько параллельных запросов. Прежде чем делать 
новый запрос клиент должен дождаться ответа на предыдущий запрос. Иначе 
поведение сервера не определено.

Сервер на любой запрос отвечает определённым сообщением, которое 
соответствует запросу либо сообщением Error в случае возникновения ошибки. 
Сообщение Error всегда следует ожидать при выполнении любого запроса в 
случае кода ошибки InternalError.

Сервер может в любое время согласно подписке на события отправить оповещение,
оповещение может быть получено во время обработки запроса, поэтому не 
следует ожидать, что следующее сообщение от сервера гарантированно будет 
сообщением ответа на запрос.

# Package com.handtruth.net.lab3.sevent.options

## Используемые опции

|**option_id**|Имя опции |Поля опции                   |Назначение                                          |
|-------------|----------|-----------------------------|----------------------------------------------------|
|1            |EventID   |id: *VarInt*                 |идентификатор события, которое участвует в операции |
|2            |EventType |type: *String*               |тип события, который участвует в операции           |
|3            |EventIDs  |ids: *VarList\<VarInt\>*     |идентификаторы события, которые участвуют в операции|
|4            |EventTypes|types: *VarList\<VarString\>*|имена типов событий, которые участвуют в операции   |

# Package com.handtruth.net.lab3.sevent.types

## Используемые типы данных

### *Duration*

Инкапсулирует тип *Double*.

Представляет собой временной интервал, который хранит количество секунд в 
инкапсулируемом типе *Double*.

### *Event*

Тип Event описывает некоторые данные о событии и включает в себя следующий 
набор полей:

|Имя        |Тип данных |Смысл                         |
|-----------|-----------|------------------------------|
|description|*VarString*|описание события              |
|period     |*Duration* |период оповещения о событии   |
|repeat     |*VarInt*   |количество оставшихся повторов|

# Package com.handtruth.net.lab3.sevent.message

## Используемые сообщения

### Error

Код сообщения (**id**) = 1.

Сообщение является ответом на запросы клиента к серверу для тех случаев, 
когда запрос выполнить либо не возможно, либо не вышло.

Сообщение Error состоит из следующих полей:

|Имя        |Тип данных |Смысл                                                                  |
|-----------|-----------|-----------------------------------------------------------------------|
|lastId     |*Byte*     |октет с кодом сообщения запроса, на которое не удалось ответить успешно|
|errorCode  |*Byte*     |октет с кодом ошибки, ниже приведены коды ошибок                       |
|message    |*String*   |строка из остальных байт в пакете с текстовым пояснением ошибки        |

Коды ошибок:

|Код|Имя            |Смысл                                           |
|---|---------------|------------------------------------------------|
|1  |FormatError    |ошибка формата сообщения, полученного от клиента|
|2  |InvalidProperty|неверное значение в одном из полей запроса      |
|3  |InternalError  |внутренняя ошибка сервера                       |
|4  |EventNotExists |событие не существует                           |
|5  |WrongMessage   |на этот тип сообщений сервер не отвечает        |

### RegisterEvent

Код сообщения (**id**) = 2.

Сообщение RegisterEvent отвечает за регистрация события в системе его может 
послать клиент в любой момент.

Сообщение RegisterEvent состоит из следующих полей в **body**:

|Имя  |Тип данных |Смысл                      |
|-----|-----------|---------------------------|
|event|*Event*    |данные добавляемого события|

Кроме этого сервер реагирует на опции EventType и EventTypes для установки 
типов события. Можно применить несколько раз эти опции в любом сочетании. 
Сервер должен считать их все и извлечь имена типов события из всех 
предоставленных опций.

При отправке сообщения RegisterEvent с отрицательным значением period поля 
event сервер отправит сообщение Error с кодом ошибки InvalidProperty.

Серверное ПО может наложить дополнительные ограничения на поле period. В 
случае их нарушения будет отправлено сообщение Error с кодом ошибки 
InvalidProperty.

При отправке сообщения RegisterEvent с отрицательным значением и не равным -1 
repeat поля event сервер отправит сообщение Error с кодом ошибки 
InvalidProperty.

В случае успеха сервер добавит событие в систему и ответит сообщением 
EventRegistration с идентификатором события и временем регистрации события в 
системе.

### EventRegistration

Код сообщения (**id**) = 3.

Сообщение EventRegistration приходит в ответ на запрос RegisterEvent в 
случае успеха. Данное сообщение содержит дополнительные данные о 
зарегистрированном событии.

Сообщение EventRegistration состоит из следующих полей в **body**.

|Имя      |Тип данных |Смысл                                    |
|---------|-----------|-----------------------------------------|
|timestamp|*Time*     |время создания события секундной точности|

Кроме этого сообщение EventRegistration всегда включает в себя опцию EventID 
с идентификатором зарегистрированного события в ответ на регистрацию 
которого и было сформировано сообщение EventRegistration.

### ListEvents

Код сообщения (**id**) = 4.

Сообщение ListEvents может быть отправлено клиентом в любой момент и в ответ 
на это сообщение сервер отправит список идентификаторов событий, которые 
присутствуют в системе на данный момент.

Данное сообщение не имеет полей в **body**.

В сообщение могут включаться опции EventType и(или) EventTypes в любой 
комбинации в любом количестве. В этом случае их значения будут использованы 
для выборки событий по перечисленным в этих опциях типам событий. События не
входящие в эту выборку не будут включены в ответное сообщение от сервера.

При отсутствии опций EventType и(или) EventTypes будут выбраны все 
присутствующие в системе события.

Ответом на сообщение ListEvents будет сообщение ListedEvents.

### ListedEvents.

Код сообщения (**id**) = 5.

Сообщение ListedEvents является ответом сервера на сообщение ListEvents, 
которое было послано клиентом.

Сообщение ListedEvents не имеет полей в области **body**, но гарантированно 
имеет опцию EventIDs, в которой перечислены все идентификаторы событий, 
включённые в выборку по параметрам запроса соответствующего сообщения 
ListEvents.

### DeleteEvent

Код сообщения (**id**) = 6.

Сообщение DeleteEvent может быть отправлено клиентом в любой момент.

Сообщение DeleteEvent не имеет полей в области **body**.

Сообщение DeleteEvent может включать в себя опции EventID, EventIDs, 
EventType и(или) EventTypes в любой комбинации в любом количестве.

Все события, типы которых перечислены в опциях EventType и EventTypes будут 
удалены из системы, а из их идентификаторов будет сделан список list1.

Все события, идентификаторы которых перечислены в опциях EventID и EventIDs 
будут удалены из системы, а из идентификаторов удалённых событий будет 
сделан список list2. Если событие с указанным идентификатором не было 
найдено, то для данного идентификатора не будет сделано операции удаления.

В результате успешного выполнения операции по запросу DeleteEvent в ответ 
сервер вышлет сообщение DeletedEvents в котором будут задействованы 
идентификаторы из list1 и list2.

### DeletedEvents

Код сообщения (**id**) = 7.

Сообщение DeletedEvents является ответом сервера на сообщение DeleteEvent,
которое было послано клиентом.

Сообщение DeletedEvents не имеет полей в области **body**.

Сообщение гарантированно включает в себя одну опцию EventIDs в которой 
перечислены идентификаторы удалённых из системы событий.

### Subscribe

Код сообщения (**id**) = 8.

Сообщение Subscribe может быть отправлено клиентом в любой момент.

Сообщение Subscribe не имеет полей в области **body**.

Сообщение Subscribe может включать в себя опции EventID, EventIDs,
EventType и(или) EventTypes в любой комбинации в любом количестве.

После получения данного сообщения сервер обновляет фильтр оповещений о 
событиях для данной сессии, а именно добавляет идентификаторы событий и типы 
событий из опций в фильтр. Если события с идентификатором, перечисленного в 
опциях EventID и EventIDs не существует, то в ответ на данное сообщение 
клиент получит сообщение Error с кодом ошибки EventNotExists. При этом 
фильтр не будет обновлён даже для тех идентификаторов и типов, для которых 
запрос мог бы быть выполнен успешно.

В случае успеха в ответ на сообщение Subscribe сервер вышлет сообщение 
FilterUpdated.

### Unsubscribe

Код сообщения (**id**) = 9.

Сообщение Unsubscribe может быть отправлено клиентом в любой момент.

Сообщение Unsubscribe не имеет полей в области **body**.

Сообщение Unsubscribe может включать в себя опции EventID, EventIDs,
EventType и(или) EventTypes в любой комбинации в любом количестве.

После получения данного сообщения сервер обновляет фильтр оповещений о
событиях для данной сессии, а именно удаляет идентификаторы событий и типы
событий из опций из фильтра. Если события с идентификатором, перечисленного в
опциях EventID и EventIDs не существует, то в ответ на данное сообщение
клиент получит сообщение Error с кодом ошибки EventNotExists. При этом
фильтр не будет обновлён даже для тех идентификаторов и типов, для которых
запрос мог бы быть выполнен успешно.

В случае успеха в ответ на сообщение Subscribe сервер вышлет сообщение
FilterUpdated.

### FilterUpdated

Код сообщения (**id**) = 10.

Данное сообщение будет выслано в случае успеха в ответ на запросы Subscribe, 
Unsubscribe и Filter.

Сообщение FilterUpdated не имеет полей в области **body**.

Сообщение FilterUpdated не имеет опций.

### GetFilter

Код сообщения (**id**) = 11.

Сообщение GetFilter может быть отправлено клиентом в любой момент.

Сообщение GetFilter не имеет полей в области **body**.

Сообщение GetFilter не имеет опций.

При получении сообщения GetFilter сервер отправляет сообщение Filter с 
информацией о фильтре данной сессии.

### Filter

Код сообщения (**id**) = 12.

Сообщение Filter может быть отправлено клиентом в любой момент.

Сообщение Filter не имеет полей в области **body**.

Сообщение Filter может включать в себя опции EventID, EventIDs,
EventType и(или) EventTypes в любой комбинации в любом количестве при 
отправке от клиента.

Сообщение Filter гарантированно включает в себя по одной опции типов 
EventTypes и EventIDs в случае отправки со стороны сервера.

Данное сообщение хранит информацию о фильтре. В опциях сообщения перечислены 
типы событий и идентификаторы событий, которые используются для фильтрации 
получаемых уведомлений.

Сообщение Filter является ответом сервера на запрос GetFilter от клиента. В 
таком случае сообщение содержит идентификаторы событий и типы событий, 
которые входят в фильтр текущей сессии на момент запроса.

При отправке сообщения Filter клиентом, сервер заменяет текущий фильтр 
данными в опциях этого сообщения. Если события с идентификатором, 
перечисленного в опциях EventID и EventIDs не существует, то в ответ на 
данное сообщение клиент получит сообщение Error с кодом ошибки 
EventNotExists. При этом фильтр не будет замещён (останется тот фильтр, что 
присутствовал до запроса).

### GetEvent

Код сообщения (**id**) = 13.

Сообщение GetEvent может быть отправлено клиентом в любой момент.

Сообщение GetEvent не имеет полей в области **body**.

Сообщение GetEvent должно включать в себя одну опцию EventID.

Сообщение GetEvent отправляется клиентом в целях получения подробной 
информации о конкретном событии в системе. В опции EventID следует указать 
идентификатор запрашиваемого события.

Если события с указанным идентификатором не существует, то сервер ответит 
сообщением Error с кодом ошибки EventNotExists.

В случае успеха сервер отправит в ответ сообщение EventInfo с информацией о 
запрашиваемом событии.

### EventInfo

Код сообщения (**id**) = 14.

Сообщение EventInfo является ответом на успешный запрос GetEvent.

Сообщение EventInfo гарантированно имеет опцию EventID, в которой
хранится идентификатор, присутствовавший в такой же опции в запросе GetEvent.

Сообщение EventInfo гарантированно имеет опцию EventTypes, в которой
перечислены все типы, к которым относится событие, данные которого 
представлены в этом сообщении.

Сообщение EventInfo имеет следующий набор полей в области **body**:

|Имя      |Тип данных |Смысл                                                 |
|---------|-----------|------------------------------------------------------|
|event    |*Event*    |данные события                                        |
|timestamp|*Time*     |время последнего обновления события секундной точности|

Поля в сообщении EventInfo соответствуют данным события, которое было 
запрошено по идентификатору в опции EventID в запросе GetEvent.

### Notify

Код сообщения (**id**) = 15.

Сообщение Notify отправляется сервером при оповещении клиента о произошедшем 
событии, на которое клиент был подписан по информации фильтра привязанного к 
сессии.

Сообщение Notify может быть отправлено в любой момент даже при обработке 
запроса этой же сессии.

Сообщение Notify гарантированно имеет опцию EventID, в которой
хранится идентификатор произошедшего события.

Сообщение Notify гарантированно имеет опцию EventTypes, в которой
перечислены все типы, к которым относится событие, данные которого
представлены в этом сообщении.

Область **body** сообщения Notify содержит следующий набор полей:

|Имя      |Тип данных |Смысл                                                 |
|---------|-----------|------------------------------------------------------|
|event    |*Event*    |данные события                                        |
|timestamp|*Time*     |время последнего обновления события секундной точности|

Данные поля отражают состояние произошедшего события на момент до его 
обновления в связи с этим оповещением.

Таким образом поле event.repeat не может иметь значения 0.
